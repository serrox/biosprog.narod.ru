<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Низкоуровневое програмирование</title>
	<meta name="keywords" content="программирование, DOS, INT 2F, реальный режим, ассемблер, Мультиплексное прерывание, печать" />
	<meta name="description" content="Низкоуровневое программирование: Прерывания DOS: INT 2Fh: Мультиплексное прерывание." />
</head>
<body>
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
(function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter2269369 = new Ya.Metrika({id:2269369,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
})(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="//mc.yandex.ru/watch/2269369" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
	<a href=../../index.htm>Главная</a> - <a href=../index.htm> Реальный режим </a> - <a href=ints.htm>Прерывания DOS</a> - <b>INT 2Fh: Мультиплексное прерывание.</b><br />
	<h2>INT 2Fh: Мультиплексное прерывание.</h2>
<!--<table border=1 width=100%><tr><td>AH</td><td>номер мультиплексного процесса </td></tr><tr><td valign=top>
01h</td><td> резидентная порция команды DOS 'PRINT' <br />
 	<table border=1 width=100%><tr><td>AL</td><td>подфункция</td></tr><tr><td valign=top>
	0</td><td>опросить статус установки процесса <br />
	Выход: <br />
	AL == 00h =&gt; не установлен, можно устанавливать <br />
	AL == 01h =&gt; не установлен, нельзя устанавливать <br />
	AL == FFh =&gt; установлен</td></tr><tr><td valign=top>
	1</td><td>направить файл к спулеру <br />
	DS:DX =&gt; направляемый пакет <br />
	смещение 0 =уровень (всегда 0 для DOS 3.0, 3.1 и 3.2) <br />
	смещение 1 =DWORD адрес (смещение,сегмент) строки ASCIIZ, содержащей диск, путь и имя файла, направляемого в очередь печати (глобальные - обобщенные - имена НЕ допускаются) 


02h = резидентная порция команды DOS 'ASSIGN' <br />
10h = резидентная порция команды DOS 'SHARE' <br />
03h-7Fh (зарезервировано) <br />
80h-0FFh(доступно для других процессов)<br /> 
AL = номер подфункции <br />
прочие = зависят от подфункций и конкретных мультиплексных процессов 
Выход: 
AX = код ошибки, если взведен флаг CF (для процессов DOS) 
AL = статус установки (для процессов DOS) 
00h = не установлен. можно устанавливать 
01h = не установлен. Нельзя устанавливать 
FFh = установлен 

Этот вектор (0000:00BC) предоставляет средства управления процессами, доступные всей системе из любого приложения. 

Каждый процесс должен включить себя в цепочку прерываний с этим кодом, и каждый процесс в цепочке должен проверять AH на свой мультиплексный номер процесса. Если запрос относится к другому процессу, активный процесс должен передать управление по первоначальному адресу прерывания 2fH (по адресу, который был в векторе 0:00BC перед тем, как текущий процесс установил себя). 
Версии DOS: 

INT 2Fh не определено для более ранних версий, чем DOS 3.0 В DOS 3.0, INT 2Fh определено ТОЛЬКО для PRINT, и значение AH (которое определяет номер процесса) не определено. В DOS 3.2, этот вектор определен так, как описано выше. 
Print Spooler: 
AH=1 (или AH=что угодно для DOS 2.x) это - интерфейс, определяемый для фоновой печати (печатного спулинга) после выполнения команды DOS 'PRINT'. 
AL - номер подфункции (0-5). все подфункции могут возвращать ошибки (см. ниже). 
AL = 0: опросить статус установки процесса 
Выход: 
AL = 00h = не установлен, можно устанавливать 
AL = 01h = не установлен, нельзя устанавливать 
AL = FFh = установлен 

AL = 1: направить файл к спулеру 
DS:DX => направляемый пакет 
смещение 0 =уровень (всегда 0 для DOS 3.0, 3.1 и 3.2) 
смещение 1 =DWORD адрес (смещение,сегмент) строки ASCIIZ, содержащей диск, путь и имя файла, направляемого в очередь печати (глобальные - обобщенные - имена НЕ допускаются) 

AL = 2: снять выбранные файлы 
DS:DX => строка ASCIIZ с именем удаляемого из очереди файла (глобальные символы допускаются в имени) 

AL = 3: Снять все файлы (удалить все файлы из очереди и остановить печать) 

AL = 4: статус. возвращает счетчик ошибок и задерживает очередь для изучения. 

используйте подфункцию 5, чтобы освободить очередь. 

Возвращает: DS:SI => блок описания файла в очереди. Один или несколько блоков с ASCIIZ-именами файлов. Конец блока отмечается именем, начинающимся с 00H. 

DX = счетчик последовательных ошибок, встретившихся при попытке вывода последнего символа. 
AL = 5: конец статуса. Освобождает очередь для продолжения печати. 

AL = 0F8h-0FFh: (резервируется для DOS) 
Ошибки спулера: 

Если установлен флаг CF, то AX содержит код ошибки: 
AX = 1 - неверный номер функции 
AX = 2 - файл не найден 
AX = 3 - Путь не найден 
AX = 4 - Слишком много файлов (нет доступных описателей) 
AX = 5 - доступ отвергнут 
AX = 6 - неверный описатель (handle) 
AX = 8 - переполнение очереди 
AX = 9 - Занято 
AX = 0Ch - Путь и имя файла превышают 64 символа 
AX = 0Fh - неверный диск 
Assign 

AH=2 - мультиплексный номер для резидентной порции команды DOS 'ASSIGN'. Определена только подфункция AL=0 (дать статус установки). 
Share 

AH=10h - мультиплексный номер резидентной порции команды DOS 'SHARE'. Определена только подфункция AL=0 (дать статус установки). 
Создание собственного процесса 

Руководство DOS Tech Ref разъясняет, что вы можете использовать INT 2Fh как вход для установки и доступа к вашему собственному резидентному процессу. Идея состоит в следующем: если вы произвольно используете вектор прерывания для вашего собственного доступа, то вы подвергаетесь определенному риску, особенно в мультизадачной системе. если же вы используете предлагаемую мультиплексную "цепочку", то DOS знает о вас, и ваш вектор не будет перекрыт другим обработчиком. Одна возможная проблема: нет предопределенного способа определить мультиплексный номер вашего процесса (регистр AH). Плохо привязываться к конкретному числу, ибо нет гарантии, что другой процесс не будет использовать этот же номер. Вы должны предусмотреть какую-то логику, гарантирующую вам четкое опознание вашего процесса. 

Ваш процесс должен по меньшей мере использовать подфункцию AL=0, чтобы вы могли выяснить, не был ли процесс уже установлен ранее. 
Замечание: 

Если ваш процесс использует сервис DOS, или выполняется с незамаскированными прерываниями, то он должен быть реентерабельным.-->

Это прерывание спроектированно как интерфейс для резидентных программ. Логика работы следующая: <br />
В регистре AH задаётся номер резидентной программы<br />
В регистре AL задаётся номер вызываемой функции<br />
При этом функция 0 должна быть функцией проверки наличия резидентной программы. Эта функция должно вернуть код статуса в AL. Известны следующие коды статуса:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AL == 0 - этот номер резидентной программы свободен<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AL == 1 - этот номер резидентной программы зарезервирован<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AL == FFh - этот номер резидентной программы занят (можно обращаться к другим функциям)<br /><br />
Способ добавить свою программу в это прерывание очень прост: надо сохранить старый вектор прерывания, затем записать свой. При вызове прерывание перво-наперво необходимо проверить, что переданный код резидентной программы соответствует вашей программе. Если не соответствует - переходим на старый обработчик прерывания (инструкцией jmp!).<br />
Перед добавлением программы стоит удостоверится что выбранный вами номер резидентной программы ещё не занят и не зарезервирован.<br />
В идеале - необходимо провести перебор по номеру резидентной программы и найти свободный, однако большинство программ имеют жёстко заданный номер.<br />
Кроме того, существует следующее соглашение о номерах:<br />
&nbsp;&nbsp;&nbsp;&nbsp;00h-3Fh Зарезервированно IBM для функций DOS<br />
&nbsp;&nbsp;&nbsp;&nbsp;40h-7Fh Зарезервированно Microsoft для функций DOS<br />
&nbsp;&nbsp;&nbsp;&nbsp;80h-B7h Зарезервированно IBM<br />
&nbsp;&nbsp;&nbsp;&nbsp;B8h-BFh Зарезервированно для работы с сетью<br />
&nbsp;&nbsp;&nbsp;&nbsp;C0h-FFh Для прочих приложений<br />
<i>(слово "зарезервированнно" в этом списке никак не соотносится со словом "зарезервированно" в списке возможных возвращаемых значений функции 0)</i><br />
Если ваш процесс использует сервис DOS, или выполняется с незамаскированными прерываниями, то он должен быть реентерабельным.<br />
<br />
Кроме того, прерывание 2F стало мультиплексным только в DOS 3.0, в DOS 2.0 оно служило для сервиса печати, и имело несовместимый с более новой версией интерфейс. Более ранние версии DOS никак не определяли это прерывание.<br />
<br/>
<h3>Оглавление</h3>
<ul>
	<li><a href="#print">API Печати для DOS 3.0+</a></li>
</ul>
<a name=print><h3>API Печати для DOS 3.0+</h3></a><br />
Резидентная часть команды PRINT<br />
В AH передаётся 1
<table border=1 width=100%><tr><td>AL</td><td>подфункция</td></tr><tr><td valign=top>
  0</td><td>Проверит наличие<br /><br/>
	<b>Выход:</b><br/>
	AL == 00h =&gt; не установлен, можно устанавливать <br />
	AL == 01h =&gt; не установлен, нельзя устанавливать <br />
	AL == FFh =&gt; установлен<br /><br />
	<b>Примечание:</b><br/>
	Novell DOS версии 7 обнуляет регистр AH</td></tr><tr><td valign=top>
  1</td><td/>Добавить файл в очередь печати<br /><br/>
	<b>Вход:</b><br/>
	DS:DX =&gt; направляемый пакет <br />
	Байт 0 -уровень (всегда 0 для DOS 3.0, 3.1 и 3.2) <br />
	Байты 1-2 - адрес (смещение,сегмент) строки ASCIIZ, содержащей полный путь к файлу, направляемого в очередь печати<br /><br/>
	<b>Выход:</b><br/>
	Если установлен флаг CF, то произошла ошибка, и AX содержит <a href="#code">код ошибки</a></td></tr><tr><td valign=top>
  2</td><td>Удалить файл из очереди печати<br /><br/>
	<b>Вход:</b><br/>
	DS:DX - адрес (смещение,сегмент) строки ASCIIZ, содержащей полный путь к файлу, направляемого в очередь печати<br /><br/>
	<b>Выход:</b><br/>
	Если установлен флаг CF, то произошла ошибка, и AX содержит <a href="#code">код ошибки</a></td></tr><tr><td valign=top>
  3</td><td>Очистить очередь печати<br /><br />
	<b>Выход:</b><br/>
	Если установлен флаг CF, то произошла ошибка, и AX содержит <a href="#code">код ошибки</a></td></tr><tr><td valign=top>
  <a name="4">4</a></td><td>Приостановить печать и получить статус<br /><br />
	<b>Выход:</b><br/>
	DX - количество возникших ошибок с последнего вызова этой функции<br />
	DS:SI - очередь печати<br />
	Если установлен флаг CF, то произошла ошибка, и AX содержит <a href="#code">код ошибки</a><br /><br />
	<b>Примечание:</b><br/>
	Очередь печати представляет из себя массив строк, каждая из которых имеет длинну 64 байта и содержит полный путь к печатаемому файлу<br />
	Первая запись в масииве - файл, который печатается сейчас. Признаком конца массива является пустая запись.</td></tr><tr><td valign=top>
  5</td><td>Продолжить печать<br /><br />
	<b>Выход:</b><br/>
	Если установлен флаг CF, то произошла ошибка, и AX содержит <a href="#code">код ошибки</a><br />
	Эта функция вызывается для возобновления печати после выполнения <a href="#4">функции 4</a></td></tr><tr><td valign=top>
  6</td><td>Узнать используемый принтер<font color=red><b>DOS 3.3+</b></font><br /><br />
	<b>Выход:</b><br/>
	Если флаг CF установлен:<br/>
	&nbsp;&nbsp;&nbsp;&nbsp;В очереди печати есть файлы<br/>
	&nbsp;&nbsp;&nbsp;&nbsp;AX - код ошибки<br/>
	&nbsp;&nbsp;&nbsp;&nbsp;DS:SI - указатель на заголовок драйвера устройства<br/>
	Если флаг CF установлен:<br/>
	&nbsp;&nbsp;&nbsp;&nbsp;Очередь печати пуста<br/>
	&nbsp;&nbsp;&nbsp;&nbsp;AX=0</td></tr>
</table>
<br />
<a name=code>Коды ошибок API Печати для DOS 3.0+</a><br />
<table border=1 width=100%>
<tr><td>Код</td><td>Значение</td></tr><tr><td valign=top>
01</td><td>Невеврный номер функции</td></tr><tr><td valign=top>
02</td><td>Файл не найден</td></tr><tr><td valign=top>
03</td><td>Путь не найден</td></tr><tr><td valign=top>
04</td><td>Нет доступного HANDLE (слишком много открытых файлов</td></tr><tr><td valign=top>
05</td><td>Ошибка доступа</td></tr><tr><td valign=top>
06</td><td>Неверный HANDLE</td></tr><tr><td valign=top>
08</td><td>Очередь переполнена</td></tr><tr><td valign=top>
09</td><td>Программа печати занята</td></tr><tr><td valign=top>
0Ch</td><td>Полный путь к файлу слишком длинный</td></tr><tr><td valign=top>
0Fh</td><td>Неверный диск</td></tr>
</table>
</body>
</html>