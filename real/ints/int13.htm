<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Низкоуровневое програмирование</title>
	<meta name="keywords" content="программирование BIOS INT INT13 реальный режим ассемблер 16bit дисковый сервис" />
	<meta name="description" content="Низкоуровневое программирование: Прерывания БИОС: INT 13" />
</head>
<body>
	<a href=../../index.htm>Главная</a> - <a href=../index.htm> Реальный режим </a> - <a href=int.htm>Прерывания Bios</a> - <b>INT 13h: Дисковый ввод-вывод .</b><br />
	<h2>INT 13h: Дисковый ввод-вывод .</h2>
	<div style="font-size: 13pt">Данное прерывание реализует несколько наборов API для работы с дисками</div><br/>
	<h3>"Класический" API</h3>
	<div style="font-size: 13pt">Класический API использует адресацию в формате CHS (Цилиндр-Головка-Сектор), отводя под адрес 24 бита, и при этом имеет "разрывы" в нумерации. Таким образом возможно адресовать до 7,8 Гб информации, и поэтому данный API является устаревшим и миеет смысл если вы работаете с дискетами или на старом компьютере, не поддерживающем новые API.<br/>
	Хотя максимальный адресуемый размер зависит от размера сектора, обычно приводится предел в 7,8 или 8 Гб, т.к. димки с размером сектора, отличным от 512 Кб являются редкостью, а современные диски в силу определённых причин "скрывать" реальную геометрию за некими усреднёнными параметрами.<br/></div>
<table border=1 width=100%><tr><td valign=top>AH</td><td> функция </td></tr><tr><td valign=top>
0</td><td>Сброс устройства.<br />
		<b>Вход:</b><br/>
		DL - номер устройства<br/>
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		<b>Примечание:</b><br/>
		Вызывает рекалибрацию контроллера. Если DL равен 80H или 81H, выполнен сброс контроллера жесткого диска, иначе FDD.</td></tr><tr><td valign=top>
1</td><td>Дать статус ошибки последней операции.<br />
		<b>Вход:</b><br/>
		DL = диск.<br />
		<b>Выход:</b><br/>
		AH содержит <a href=#code>код ошибки диска</a><br/>
		<b>Примечание:</b><br/>
		Некоторые БИОСы учитывают ошибки не всех операций </td></tr><tr><td valign=top>
<a name=2>2</a></td><td>Читать секторы<br />
		<b>Вход:</b><br/>
		DL = номер диска (0=диск A...; 80h=HDD 0; 81h=HDD 1...) (обычно при запуске системы номер диска, с которого проведён запуск  передаётся в dl, но НЕ при запуске программы в DOS)<br />
        DH = номер головки чтения/записи<br />
        CH = биты 0-7 номера дорожки (цилиндра)<br />
        CL =<br />
		&nbsp;&nbsp;биты 0-5 - номер сектора (Считая с 1)<br />
		&nbsp;&nbsp;биты 6-7 - биты 8-9 номера дорожки<br />
        AL = число секторов<br />
        ES:BX => адрес буфера вызывающей программы<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
        ES:BX буфер содержит данные, прочитанные с диска.<br />
		AL - количество считанных секторов (кроме ошибки 11h)<br/>
		<b>Примечание:</b><br/>
		Старые БИОСы могут не поддерживать переход с одной дорожки на другую в процессе чтения, так что будте осторожны!<br/>
		Документация на PhoenixBios (rev 6) утверждает, что максимальное значение, передаваемое в AL - 80h</td></tr><tr><td valign=top>
3</td><td>Писать секторы<br />
		<b>Вход:</b><br/>
		DL = номер диска (0=диск A...; 80h=HDD 0; 81h=HDD 1...) (обычно при запуске системы номер диска, с которого проведён запуск  передаётся в dl, но НЕ при запуске программы в DOS)<br />
        DH = номер головки чтения/записи<br />
        CH = биты 0-7 номера дорожки (цилиндра)<br />
        CL =<br />
		&nbsp;&nbsp;биты 0-5 - номер сектора (Считая с 1)<br />
		&nbsp;&nbsp;биты 6-7 - биты 8-9 номера дорожки<br />
        AL = число секторов (в сумме не больше чем один цилиндр)<br />
        ES:BX => адрес буфера вызывающей программы<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		AL - количество записанных секторов<br/>
		<b>Примечание:</b><br/>
		Старые БИОСы могут не поддерживать переход с одной дорожки на другую в процессе записи, так что будте осторожны!<br/>
		Документация на PhoenixBios (rev 6) утверждает, что максимальное значение, передаваемое в AL - 80h</td></tr><tr><td valign=top>
4</td><td>Проверить секторы. проверяет CRC для указанных секторов на ошибки.<br />
		<b>Вход:</b><br/>
		DL = номер диска (0=диск A...; 80h=HDD 0; 81h=HDD 1...) (обычно при запуске системы номер диска, с которого проведён запуск  передаётся в dl, но НЕ при запуске программы в DOS)<br />
        DH = номер головки чтения/записи<br />
        CH = биты 0-7 номера дорожки (цилиндра)<br />
        CL =<br />
		&nbsp;&nbsp;биты 0-5 - номер сектора (Считая с 1)<br />
		&nbsp;&nbsp;биты 6-7 - биты 8-9 номера дорожки<br />
        AL = число секторов (в сумме не больше чем один цилиндр)<br />
        Для биосов старше 15 ноября 1985-го года: ES:BX => адрес буфера вызывающей программы<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		AL - количество проверенных секторов<br/>
		<b>Примечание:</b><br/>
		Старые БИОСы могут не поддерживать переход с одной дорожки на другую в процессе записи, так что будте осторожны!<br/>
		Документация на PhoenixBios (rev 6) утверждает, что максимальное значение, передаваемое в AL - 80h, а для дисков с ECC - 79h</td></tr><tr><td valign=top>
5</td><td>Форматировать дорожку. данные на дорожке, если есть, разрушаются.<br />
		<b>Вход:</b><br/>
		DL,DH,CH = диск,головка,дорожка (см. фуекцию <a href=int13.htm#2>02H</a>)<br />
        ES:BX => дескрипторы секторов (формат дескрипторов см. ниже)<br/>
        &nbsp;&nbsp;дискета: 4-байтовый 'CHNS' (C - цилиндр,H - головка,N - сектор, S - размер) для каждого сектора на дорожке (т.е. 36 байт для 9-секторных дорожек); номера секторов должны быть упорядочены. 'S' - код размера сектора:  0=128; 1=256; 2=512; 3=1024<br />
        &nbsp;&nbsp;<font color=red>для AT</font> Тв. диск: 2-байтовый 'FN' (F - флаг,N - сектора) для каждого сектора на дорожке. последовательность полей 'N' определяет "коэффициент прослаивания" ("interleave factor").<br />
        &nbsp;&nbsp;<font color=red>для XT</font> Тв. диск: ES:BX не используется. Вместо этого AL содержит значениеv"прослаивания" между 1 и 16 (10h).<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
        (тв. диск: 'F'-поля установлены в 80H, чтобы пометить плохие секторы)<br />
		AL - количество отформатированных секторов</td></tr><tr><td valign=top>
8</td><td>Параметры диска<br />
		<b>Вход:</b><br/>
		DL = диск<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		если AL, CX или DX ==0, то произошла ошибка и <a href=#code>код ошибки диска</a> в AH.<br />
		DL = число тв. дисков на первом контроллере<br />
        DH = максимальный номер головки<br />
        CH = максимальный номер цилиндра (младшие 8 бит)<br />
        CL =<br />
		&nbsp;&nbsp;биты 0-5 - максимальный номер сектора (и старшие биты максимум номера цилиндра)<br />
		&nbsp;&nbsp;биты 6-7  - биты 8-9 максимаьного номера цилиндра<br/>
		<b>Примечание:</b><br/>
		<font color=red><b>Только AT и XT совместимые компьютеры</b></font></td></tr><tr><td valign=top>
9</td><td>Инициализировать параметры диска<br />
		<b>Вход:</b><br/>
		DL - номер диска<br/>
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		<b>Примечание:</b><br/>
		Векторы для INT 41h и INT 46h адресуют Табл. параметров тв. диска соответственно для устройств 0 и 1.<br />
		В XT совместимом компьютере обе таблицы указываются через вектор INT 40h.<br />
		<font color=red><b>Только AT совместимые компьютеры</b></font><br />
		Сообщает BIOS о любом динамическом изменении таблиц параметров устройства.</td></tr><tr><td valign=top>
0Ah</td><td>Длинное чтение<br />
		<b>Вход:</b><br/>
		DL = номер диска (0=диск A...; 80h=HDD 0; 81h=HDD 1...) (обычно при запуске системы номер диска, с которого проведён запуск  передаётся в dl, но НЕ при запуске программы в DOS)<br />
        DH = номер головки чтения/записи<br />
        CH = биты 0-7 номера дорожки (цилиндра)<br />
        CL =<br />
		&nbsp;&nbsp;биты 0-5 - номер сектора (Считая с 1)<br />
		&nbsp;&nbsp;биты 6-7 - биты 8-9 номера дорожки<br />
        AL = число секторов<br />
        ES:BX => адрес буфера вызывающей программы<br/>
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		ES:BX => считанные данные<br />
		<b>Примечание:</b><br/>
		<font color=red><b>Только AT и XT совместимые компьютеры<br/>
		Документация на PhoenixBios (rev 6) утверждает, что максимальное значение, передаваемое в AL - 79h</b></font><br /></td></tr><tr><td valign=top>
0Bh</td><td>Длинная запись<br />
<font color=red><b>Только AT и XT совместимые компьютеры</b></font><br />
Пишет 512 байт + 4-байтовый ECC.<br />
		<b>Вход:</b><br/>
		DL = номер диска (0=диск A...; 80h=HDD 0; 81h=HDD 1...) (обычно при запуске системы номер диска, с которого проведён запуск  передаётся в dl, но НЕ при запуске программы в DOS)<br />
        DH = номер головки чтения/записи<br />
        CH = биты 0-7 номера дорожки (цилиндра)<br />
        CL =<br />
		&nbsp;&nbsp;биты 0-5 - номер сектора (Считая с 1)<br />
		&nbsp;&nbsp;биты 6-7 - биты 8-9 номера дорожки<br />
        AL = число секторов<br />
        ES:BX => адрес буфера вызывающей программы<br/>
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		<b>Примечание:</b><br/>
		512 байт + 4-байтоый ECC (код коррекции ошибок).<br />
		<font color=red><b>Только AT и XT совместимые компьютеры<br/>
		Документация на PhoenixBios (rev 6) утверждает, что максимальное значение, передаваемое в AL - 79h</b></font><br /></td></tr><tr><td valign=top>
0Ch</td><td>Искать цилиндр<br />
<font color=red><b>Только AT и XT совместимые компьютеры</b></font><br />
Перемещает головку к нужной дорожке<br /><br />
     вход: DL - номер диска<br />
DH - Номер Головки<br />
CH - Номер дорожки<br />
CL - старшие биты номера дорожки<br />
    выход: Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.</td></tr><tr><td valign=top>
0Dh</td><td>Сброс устройства<br/>
<font color=red><b>Только AT и XT совместимые компьютеры</b></font><br />
Вход: DL - диск</td></tr><tr><td valign=top>
0Eh</td><td>Читать буфер секторов<br />
<font color=red><b>Только AT совместимые компьютеры</b></font><br /><br />
     вход: как для <a href=int13.htm#2>функции 02H</a><br />
    выход: Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
По адресу ES:BX содержание буфера</td></tr><tr><td valign=top>
0Fh</td><td>Писать буфер секторов<br />
<font color=red><b>Только AT совместимые компьютеры</b></font><br /><br />
     вход: как для <a href=int13.htm#2>функции 02h</a><br />
    выход: Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
По адресу ES:BX содержание буфера</td></tr><tr><td valign=top>
10h</td><td>проверить готовность устройства<br/>
<font color=red><b>Только AT и XT совместимые компьютеры</b></font><br />
     вход: DL = диск<br/>
    выход: <a href=#code>код ошибки диска</a> (статус) в AH.(обычно при запуске системы номер диска, с которого проведён запуск  передаётся в DL, но НЕ при запуске программы в DOS)</td></tr><tr><td valign=top>
11h</td><td> Рекалибровать устройство<br/>
<font color=red><b>Только AT и XT совместимые компьютеры</b></font><br />
     вход: DL = диск(обычно при запуске системы номер диска, с которого проведён запуск  передаётся в DL, но НЕ при запуске программы в DOS)<br/>
    выход: <a href=#code>код ошибки диска</a> (статус) в AH.</td></tr><tr><td valign=top>
12h</td><td> Диагностика RAM контроллера<br />
<font color=red><b>Только AT совместимые компьютеры</b></font><br /><br />
     вход: DL = диск<br/>
    выход: <a href=#code>код ошибки диска</a> (статус) в AH.</td></tr><tr><td valign=top>
13h</td><td> Диагностика устройства<br />
<font color=red><b>Только AT совместимые компьютеры</b></font><br /><br />
     вход: DL = диск<br/>
    выход: <a href=#code>код ошибки диска</a> (статус) в AH.</td></tr><tr><td valign=top>
14h</td><td> Внутренняя диагностика контроллера<br/>
<font color=red><b>Только AT и XT совместимые компьютеры</b></font><br />
     вход: DL = диск<br/>
    выход: <a href=#code>код ошибки диска</a> (статус) в AH.</td></tr><tr><td valign=top>
15h</td><td>Читать тип диска (недоступна в XT BIOS)<br />
		<b>Вход:</b><br/>
		DL = диск<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		AH = код устройства:<br />
		&nbsp;&nbsp;== 0 , AL!=3 устройство DL отсутствует<br />
		&nbsp;&nbsp;== 0 , AL==3 Жёсткий диск<br />
		&nbsp;&nbsp;== 1 дискета; статус замены диска неподдерживается<br />
		&nbsp;&nbsp;== 2 дискета; статус замены диска доступен (большинство случаев)<br />
		&nbsp;&nbsp;== 3 Жёсткий диск<br/>
		<b>Примечание:</b><br/>
		Для жёстких дисков по адресу CX:DX передаётся количество секторов<br />
		<font color=red><b>Только AT совместимые компьютеры</b></font></td></tr><tr><td valign=top>
16h</td><td>Читать статус замены диска<br />
		<b>Вход:</b><br/>
		DL = диск<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		AH = код статуса:<br />
		&nbsp;&nbsp;0 = замена диска непроизводится<br />
		&nbsp;&nbsp;1 = неверный номер диска;<br />
		&nbsp;&nbsp;6 = производится замена диска (открыта дисковая дверь), либо статус замены диска неподдерживается<br />
		&nbsp;&nbsp;80 = ошибка таймаута<br/>
		<b>Примечание:</b><br/>
		<font color=red><b>Только AT совместимые компьютеры</b></font><br/>
		Не реккомендуется использовать на очень старых биосах, так как многие из них имеют ошибки в реализации из-за которых могут "испортится" различные данные</td></tr><tr><td valign=top>
17h</td><td>Установить тип дискеты (используется перед операцией форматирования)<br />
		<b>Вход:</b><br/>
		DL = номер устройства диска (0 или 1)<br />
		AL = тип носителя диска:<br />
		&nbsp;&nbsp;0 = не используется<br />
		&nbsp;&nbsp;1 = 360K дискета в 360K устройстве<br />
		&nbsp;&nbsp;2 = 360K дискета в 1.2M устройстве<br />
		&nbsp;&nbsp;3 = 1.2M дискета в 1.2M устройстве<br />
		&nbsp;&nbsp;4 = 720K дискета в 720K или (поддерживается не всеми биосами) 1.44M устройстве<br/>
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		<b>Примечание:</b><br/>
		<font color=red><b>Только AT совместимые компьютеры</b></font><br/>
		Документация на PhoenixBios (rev 6) явно оговаривает что случай с 1.44М дискетами не поддерживается, поэтому я реккомендую использовать функцию <a href=18>18h</a></td></tr><tr><td valign=top>
<a name=18>18h</a></td><td>Установить тип диска (используется перед операцией форматирования)<br />
		<b>Вход:</b><br/>
		DL = номер устройства диска <br />
		CH = Максимальный номер цилиндра<br />
		CL :<br />
		&nbsp;&nbsp;биты 0-5 кол-во секторов на дорожке<br />
		&nbsp;&nbsp;биты 6,7 старшие биты номера цилиндра<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		ES:DI - таблица параметров дискеты
		<b>Примечание:</b><br/>
		<font color=red><b>Только AT и/или XT совместимые компьютеры</b></font>
		Не многие БИОСы устанавливают основную таблицу параметров диска в соответствии со сформированной этой функцией, по этому рекомендуется перед проведением форматирования произвести замену адреса <a href=int1e.htm>вектора прерывание 1Eh</a></td></tr><tr><td valign=top>
19h</td><td> Припарковать головки<br />
		<b>Вход:</b><br/>
		DL = номер устройства диска<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		<b>Примечание:</b><br/>
		<font color=red><b>Только XT286 совместимые компьютеры</b></font></td></tr><tr><td valign=top>
1Ah</td><td>Форматирование жесткого диска с контроллером типа ESDI<br />
AL — количество элементов в таблице дефектов; <br />
DL — номер диска; <br />
CL :<br />
бит 0: ==1 игнорировать первичную таблицу дефектов<br />
бит 1: ==1 игнорировать вторичную таблицу дефектов<br />
бит 2: ==1 обновить вторичную таблицу дефектов<br />
бит 3: ==1 выполнить анализ поверхности<br />
бит 4: ==1 генерировать прерывание INT15h в конце каждой дорожки<br />
бит 5-7: =0<br />
ES:BX — адрес таблицы дефектов.<br />
Выход: CF, АН — признак и код ошибки.<br />
</td></tr><tr><td valign=top>
20h</td><td>Получить тип дискеты<br />
		<b>Вход:</b><br/>
		DL = номер устройства диска (0 или 1)<br />
		<b>Выход:</b><br/>
		Carry-флаг=1 при ошибке и <a href=#code>код ошибки диска</a> в AH.<br />
		AL - тип:<br />
		&nbsp;&nbsp;00 - 720 кб<br />
		&nbsp;&nbsp;01 - 1.44 мб<br />
		&nbsp;&nbsp;02 - 2.88 мб<br />
		&nbsp;&nbsp;03 - 1 мб (неформатированная 720 кб)<br />
		&nbsp;&nbsp;04 - 2 мб (неформатированная 1.44 мб)<br />
		&nbsp;&nbsp;06 - 4 мб (неформатированная 2.88 мб)<br />
		&nbsp;&nbsp;0C - 360 кб<br />
		&nbsp;&nbsp;0D - 1,2 мб<br />
		&nbsp;&nbsp;0E и 0F - дискета с размером сектора 1024 кб<br />
		&nbsp;&nbsp;10 - устройство ATAPI<br />
		<b>Примечание:</b><br/>
		Некоторые старые БИОСы неподдерживают эту функцию<br />
		БИОСы Compaq изготовленные до 1993 года всегда возвращают 0 в AL
</td></tr>
</table>
<br />
<a name=code>Коды ошибок INT13h</a><br />
<table border=1 width=100%>
<tr><td>Код</td><td>Значение</td></tr><tr><td valign=top>
00</td><td>Нет ошибки</td></tr><tr><td valign=top>
01</td><td>Неизвестная/неверная комманда</td></tr><tr><td valign=top>
02</td><td>Не найдена адресная метка</td></tr><tr><td valign=top>
03</td><td>Диск защищён от записи</td></tr><tr><td valign=top>
04</td><td>Не найден сектор</td></tr><tr><td valign=top>
05</td><td>Ошибка при сбросе HDD</td></tr><tr><td valign=top>
06</td><td>Произошла замена дискеты</td></tr><tr><td valign=top>
07</td><td>Ошибка инициализации</td></tr><tr><td valign=top>
08</td><td>Ошибка DMA</td></tr><tr><td valign=top>
09</td><td>Выход за приделы 64КБ при работе с DMA</td></tr><tr><td valign=top>
0Ah</td><td>Плохой сектор</td></tr><tr><td valign=top>
0Bh</td><td>Плохая дорожка</td></tr><tr><td valign=top>
0Ch</td><td>Неправильный номер дорожки (В некоторых биосах - не правильный номер устройства)</td></tr><tr><td valign=top>
0Dh</td><td>Неправильный номер сектора</td></tr><tr><td valign=top>
0Eh</td><td>Обнаружена адресная метка управляющих данных</td></tr><tr><td valign=top>
0Fh</td><td>Ошибка DMA</td></tr><tr><td valign=top>
10h</td><td>Ошибка данных</td></tr><tr><td valign=top>
11h</td><td>Была произведена коррекция данных</td></tr><tr><td valign=top>
20h</td><td>Сбой контроллера</td></tr><tr><td valign=top>
30h</td><td>Неподдерживаемый формат дискеты</td></tr><tr><td valign=top>
31h</td><td>Дискета извлечена</td></tr><tr><td valign=top>
32h</td><td>Неподдерживаемый тип дискеты</td></tr><tr><td valign=top>
40h</td><td>Сбой при поиске дорожки</td></tr><tr><td valign=top>
80h</td><td>Ошибка таймаута</td></tr><tr><td valign=top>
AAh</td><td>Диск не готов</td></tr><tr><td valign=top>
BBh</td><td>Неисовместимый контроллер</td></tr><tr><td valign=top>
CCh</td><td>Сбой при записи</td></tr><tr><td valign=top>
E0h</td><td>Неразрешимая ошибка контроллера</td></tr><tr><td valign=top>
FFh</td><td>Ошибка при чтении</td></tr>
</table>
</body>
</html>